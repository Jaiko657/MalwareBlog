<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />

    <title>
        Windows API for Malware Development
    </title>
</head>

<body>
    <header>
        <div class="container">
            <a id="a-title" href="home.html">
                <h1>Malware Creation</h1>
            </a>
            <h2>Windows API for Malware Development</h2>

        </div>
    </header>

    <div class="container">
        <section id="main_content">
            <h1>Windows API</h1>
            <br>
            <h2>Introduction</h2>
            <p>As a malware developer, understanding the Windows API (Application Programming Interface) is crucial for creating effective and efficient malware. The Windows API, also known as the win32 API, provides a set of functions and procedures that
                allow developers to interact with the Windows operating system and its resources.</p>
            <h2>What is an API?</h2>
            <p>APIs serve as a bridge between different software components and define how they communicate with each other. In the case of the Windows API, it allows malware developers to access system resources and perform malicious activities without
                the user's knowledge.</p>

            <h2>What is WinAPI</h2>
            <p>In Windows programming, the WinAPI (Windows Application Programming Interface) is a collection of functions used to interact with the operating system. These functions are used to perform various tasks, such as reading and writing files, displaying
                windows, and communicating with other programs. While the WinAPI is a powerful tool for developers, it also presents a significant challenge for malware developers who want to evade detection.
            </p>
            <img src="img/WINAPIArchitecture.jpg" alt="Diagram of the window API Call Stack">
            <p>
                The WinAPI is <a href="antivirusfactfile.html">hooked</a> at various levels of the call stack, which can make it difficult for malware to execute code with higher privileges. Malware developers must find ways to bypass these hooks to execute
                code undetected. However, there is a solution - ntdll.</p>

            <h2>Introducing NTDLL</h2>
            <p>NTDLL is the lowest user-level library available in Windows. It provides direct access to the Windows kernel and bypasses many of the hooks in the call stack. This makes it useful for malware developers who want to evade detection and execute
                code with higher privileges.</p>
            <p>NTDLL functions are not ment to be used by developers and as such they are undocumented by windows. This however has been overcome by a incredible community effort to create a unofficial documentation for nearly all functions. <br>This is
                available at: <a href="http://undocumented.ntinternals.net/">http://undocumented.ntinternals.net/</a></p>

            <h2>Using NT Functions from NTDLL</h2>
            <p>
                To use NT functions from ntdll, you must first load the library. This can be done using the LoadLibrary function, which loads a dynamic-link library (DLL) into the address space of a calling process. Once the library is loaded, you can use the GetProcAddress
                function to retrieve the address of the NT function you want to call. Here is an example of how to load ntdll and call the NtOpenProcess function:
            </p>
            <pre>#include <windows.h>
#include <winternl.h>

typedef NTSTATUS (NTAPI* pfnNtOpenProcess)(PHANDLE, ACCESS_MASK, POBJECT_ATTRIBUTES, PCLIENT_ID);

int main()
{
    HMODULE hNtdll = LoadLibrary(L"ntdll.dll");
    pfnNtOpenProcess NtOpenProcess = (pfnNtOpenProcess)GetProcAddress(hNtdll, "NtOpenProcess");

    HANDLE hProcess;
    OBJECT_ATTRIBUTES objAttr;
    CLIENT_ID clientId;

    NtOpenProcess(&hProcess, PROCESS_ALL_ACCESS, &objAttr, &clientId);

    return 0;
}</pre>

            <h2>NTDLL Hooks</h2>
            <p>Hooks are typically implemented using kernel-level drivers or DLL injections, which allows them to intercept system calls at various points in the call stack. For example, a hook might be placed on a specific function within ntdll, such as
                NtOpenProcess, to monitor any calls made to that function by a process.</p>
            <p>Hooks are employed as a means of intercepting and tracking system calls in libraries such as ntdll. Although they are a vital component of EDR solutions used for safeguarding against threats, they can be compromised by malware through various
                techniques, including unhooking. By disabling, removing or replacing legitimate hooks with their own, malware can go unnoticed and successfully bypass EDR solutions.</p>
            <h2>Reloading NTDLL</h2>
            <p>It's possible to reload ntdll from within a process, which can be used to bypass security measures that rely on hooks within ntdll. This technique is often used by malware developers to evade detection. Here is an example of how to reload
                ntdll:
            </p>
            <pre>#include <Windows.h>

int main()
{
    HMODULE hNtdll = LoadLibrary(L"ntdll.dll");

    // ... do something with ntdll ...

    FreeLibrary(hNtdll);

    // ... ntdll is now unloaded ...

    hNtdll = LoadLibrary(L"ntdll.dll");

    // ... ntdll is now reloaded ...
    
    return 0;
}</pre>
            <h2>Sources</h2>
            <ul>
                <li><a href="https://yuval0x92.wordpress.com/2020/03/09/native-api-win32-api/">Native API & Win32 API</a></li>
                <li>
                    <a href="https://fourcore.io/blogs/how-a-windows-process-is-created-part-1">Genesis - The Birth Of A Windows Process</a>
                </li>
            </ul>
        </section>

        <hr>
        <footer>
            <nav>
                <a href="home.html" class="footer-link" id="home-link">Home</a>
                <a href="installingnim.html" class="footer-link" id="installingnim-link">Installing Nim</a>
                <a href="basicnimshell.html" class="footer-link" id="basicnimshell-link">Basic Nim Shell</a>
                <a href="obfuscatingnimshell.html" class="footer-link" id="obfuscatingnimshell-link">Obfuscating Nim
        Shell</a>
                <a href="processinjection.html" class="footer-link" id="processinjection-link">Process Injection</a>
                <a href="customencoder.html" class="footer-link" id="customencoder-link">Custom Encoder</a>
                <a href="developmentsetup.html" class="footer-link" id="developmentsetup-link">Development Setup</a>
                <a href="antivirusfactfile.html" class="footer-link" id="antivirusfactfile-link">Antivirus Fact File</a>
            </nav>
        </footer>
</body>

</html>